#!/usr/bin/env ruby

require 'thor'
require 'aws-sdk-core'
require 'date'
require_relative 'cli/base'
require_relative 'cli/sqs'
require_relative '../lib/shoryuken/runner'

module Shoryuken
  module CLI
    class Runner < Thor
      default_task :start

      register(Shoryuken::CLI::SQS, 'sqs', 'sqs <command>', 'SQS commands')

      desc 'start', 'Start shoryuken'
      method_option :concurrency, aliases: '-c', type: :numeric, desc: 'Processor threads to use'
      method_option :daemon,      aliases: '-d', type: :boolean, desc: 'Daemonize process'
      method_option :queue,       aliases: '-q', type: :string,  desc: 'Queues to process with optional weights'
      method_option :require,     aliases: '-r', type: :string,  desc: 'Location of the worker'
      method_option :config,      aliases: '-C', type: :string,  desc: 'Path to YAML config file'
      method_option :rails,       aliases: '-R', type: :boolean, desc: 'Load Rails'
      method_option :logfile,     aliases: '-L', type: :string,  desc: 'Path to writable logfile'
      method_option :pidfile,     aliases: '-P', type: :string,  desc: 'Path to pidfile'
      method_option :verbose,     aliases: '-v', type: :string,  desc: 'Print more verbose output'
      def start
        if options[:queue]
          queue, weight = options[:queue].split(',')
          options[:queues] = [] unless options[:queues]
          options[:queues] << [queue, weight]
        end

        Shoryuken::Runner.instance.run(options.to_h)
      end

      desc 'version', 'Print version'
      def version
        puts "Shoryuken #{Shoryuken::VERSION}"
      end
    end
  end
end

Shoryuken::CLI::Runner.start
